<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>اطلاعات اشتراک</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@33.003/Vazirmatn-Variable-font-face.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          animation: { 'gradient': 'gradient 8s linear infinite' },
          keyframes: {
            'gradient': {
              '0%, 100%': { 'background-size': '200% 200%', 'background-position': 'left center' },
              '50%': { 'background-size': '200% 200%', 'background-position': 'right center' }
            }
          }
        }
      }
    }
  </script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.3s ease-out forwards; }
    .glass { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    body { font-family: 'Vazirmatn', sans-serif; }
    body.light { background: #f3f4f6 !important; color: #1f2937 !important; }
    body.light .glass { background: rgba(255, 255, 255, 0.8) !important; border-color: #d1d5db !important; color: #1f2937 !important; }
    body.light h1, body.light h2, body.light h3, body.light p, body.light span { color: #1f2937 !important; }
    body.light .bg-gradient-to-br { background-image: linear-gradient(to bottom right, #f3f4f6, #e5e7eb, #f3f4f6) !important; }
    #theme-toggle { position: fixed; top: 1rem; left: 1rem; z-index: 50; padding: 0.5rem; border-radius: 9999px; background: rgba(31, 41, 55, 0.5); cursor: pointer; transition: all 0.3s; }
    #theme-toggle:hover { background: rgba(31, 41, 55, 0.7); }
    .app-button { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.5rem; border-radius: 0.75rem; transition: all 0.3s; background: linear-gradient(to right, rgba(79, 70, 229, 0.8), rgba(109, 40, 217, 0.8)); }
    .app-button:hover { background: linear-gradient(to right, rgba(79, 70, 229, 0.9), rgba(109, 40, 217, 0.9)); transform: translateY(-2px); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white p-4 md:p-8">
  <div id="toast-notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-x-full transition-all duration-300">
    کپی شد!
  </div>
  
  <button id="theme-toggle" onclick="toggleTheme()">
    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364 6.364l-1.414-1.414M6.05 6.05L4.636 4.636m12.728 0L18.364 4.636M6.05 17.95l-1.414 1.414M12 8a4 4 0 100 8 4 4 0 000-8z" />
    </svg>
  </button>

  <div class="max-w-2xl mx-auto space-y-6">
    <div class="glass bg-gray-800/50 rounded-2xl p-8 text-center border border-gray-700/50 shadow-xl fade-in">
      <div class="relative">
        <div class="absolute inset-0 bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-full blur-3xl"></div>
        <div class="relative bg-indigo-500/10 p-4 rounded-full inline-flex">
          <svg class="w-10 h-10 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
      </div>
      <h1 class="text-3xl font-bold mt-4 mb-2">اطلاعات اشتراک</h1>
      <p class="text-gray-400 text-lg">شناسه: {{ .sId }}</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="glass bg-gray-800/50 rounded-xl p-4 border border-gray-700/50 shadow-lg fade-in">
        <div class="flex items-center space-x-3">
          <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
          <span class="text-gray-400">دانلود</span>
        </div>
        <p class="text-xl font-semibold mt-2">{{ .download }}</p>
      </div>
      <div class="glass bg-gray-800/50 rounded-xl p-4 border border-gray-700/50 shadow-lg fade-in">
        <div class="flex items-center space-x-3">
          <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
          <span class="text-gray-400">آپلود</span>
        </div>
        <p class="text-xl font-semibold mt-2">{{ .upload }}</p>
      </div>
      <div class="glass bg-gray-800/50 rounded-xl p-4 border border-gray-700/50 shadow-lg fade-in">
        <div class="flex items-center space-x-3">
          <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span class="text-gray-400">تاریخ انقضا</span>
        </div>
        <p class="text-xl font-semibold mt-2" id="expireDate"></p>
      </div>
      <div class="glass bg-gray-800/50 rounded-xl p-4 border border-gray-700/50 shadow-lg fade-in">
        <div class="flex items-center space-x-3">
          <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2l4-4" /></svg>
          <span class="text-gray-400">وضعیت</span>
        </div>
        <p class="text-xl font-semibold mt-2" id="status"></p>
      </div>
    </div>

    <div class="glass bg-gray-800/50 rounded-xl p-6 border border-gray-700/50 shadow-lg fade-in">
      <h2 class="text-lg font-semibold mb-4">نمای کلی استفاده</h2>
      <div class="w-full bg-gray-700 rounded-full h-2 mb-4">
        <div id="usageBar" class="bg-gradient-to-r from-cyan-400 to-indigo-500 h-2 rounded-full transition-all duration-500"></div>
      </div>
      <div class="flex justify-between text-sm text-gray-400">
        <span id="usedText"></span>
        <span id="remainingText"></span>
      </div>
    </div>

    <div class="glass bg-gray-800/50 rounded-xl p-6 border border-gray-700/50 shadow-lg text-center fade-in">
      <canvas id="qrcode" class="mx-auto mb-4" width="200" height="200"></canvas>
      <p class="text-gray-400">برای وارد کردن پیکربندی اسکن کنید</p>
    </div>

    <div class="glass bg-gray-800/50 rounded-xl p-6 border border-gray-700/50 shadow-lg fade-in">
      <div class="flex justify-between items-center cursor-pointer" onclick="toggleDropdown()">
        <h2 class="text-lg font-semibold">جزئیات اتصال</h2>
        <svg id="dropdownIcon" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 transform transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
      </div>
      <div id="dropdownContent" class="mt-4 space-y-3 hidden">
        <button onclick="copyAllConnections(this)" class="w-full flex justify-center items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors mb-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
          کپی همه
        </button>
        {{ range .result }}
        <div class="bg-gray-900/50 rounded-lg p-3 font-mono text-sm break-all relative group connection-item">
          <button onclick="copyIndividualConnection(this)" class="absolute right-2 top-2 p-2 rounded-lg bg-gray-800/50 hover:bg-gray-700/50 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
          </button>
          <span class="connection-text">{{ . }}</span>
        </div>
        {{ end }}
      </div>
    </div>

    <div class="flex flex-wrap gap-4 justify-center fade-in">
      <a href="v2rayng://install-config?url={{ .subUrl }}" class="app-button">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18l-6-6h12l-6 6z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v12"/></svg>
        باز کردن در V2rayNG
      </a>
      <a href="streisand://import/{{ .subUrl }}" class="app-button">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18l-6-6h12l-6 6z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v12"/></svg>
        باز کردن در Streisand
      </a>
    </div>
  </div>

<script>
    function showToast(message, success = true) {
      const toast = document.getElementById('toast-notification');
      toast.textContent = message;
      toast.classList.remove('bg-green-500', 'bg-red-500', 'opacity-0', 'translate-x-full');
      toast.classList.add(success ? 'bg-green-500' : 'bg-red-500', 'opacity-100', 'translate-x-0');
      setTimeout(() => {
        toast.classList.remove('opacity-100', 'translate-x-0');
        toast.classList.add('opacity-0', 'translate-x-full');
      }, 3000);
    }

    function toggleTheme() {
      document.body.classList.toggle('light');
      const themeButton = document.getElementById('theme-toggle');
      if (document.body.classList.contains('light')) {
        themeButton.innerHTML = `<svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M17.293 13.293A8 8 0 116.707 2.707 8 8 0 0017.293 13.293z"/></svg>`;
      } else {
        themeButton.innerHTML = `<svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364 6.364l-1.414-1.414M6.05 6.05L4.636 4.636m12.728 0L18.364 4.636M6.05 17.95l-1.414 1.414M12 8a4 4 0 100 8 4 4 0 000-8z" /></svg>`;
      }
    }

    function formatBytes(bytes, decimals = 2) {
      if (bytes === 0) return '0 بایت';
      const k = 1024;
      const sizes = ['بایت', 'کیلوبایت', 'مگابایت', 'گیگابایت', 'ترابایت'];
      const i = Math.floor(Math.log(Math.abs(bytes)) / Math.log(k));
      return parseFloat((Math.abs(bytes) / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
    }

    // FINAL FIX: Universal copy function with fallback for non-secure contexts (http or file://)
    function copyToClipboard(text, buttonElement) {
      if (!text) {
        showToast('متنی برای کپی وجود ندارد', false);
        return;
      }

      // Modern method for HTTPS/Localhost
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
          showToast('کپی شد!');
          if (buttonElement) {
            const originalHTML = buttonElement.innerHTML;
            buttonElement.innerHTML = `<svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
            setTimeout(() => { buttonElement.innerHTML = originalHTML; }, 2000);
          }
        }).catch(err => {
          showToast('خطا در کپی کردن', false);
          console.error('Modern copy failed:', err);
        });
      } else {
        // Fallback method for non-secure contexts
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
          document.execCommand('copy');
          showToast('کپی شد! (حالت سازگار)');
           if (buttonElement) {
            const originalHTML = buttonElement.innerHTML;
            buttonElement.innerHTML = `<svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
            setTimeout(() => { buttonElement.innerHTML = originalHTML; }, 2000);
          }
        } catch (err) {
          showToast('خطا در کپی کردن', false);
          console.error('Fallback copy failed:', err);
        } finally {
          document.body.removeChild(textArea);
        }
      }
    }

    // More robust function for individual copy buttons
    function copyIndividualConnection(buttonElement) {
      const parent = buttonElement.parentElement;
      const textToCopy = parent.querySelector('.connection-text').innerText.trim();
      copyToClipboard(textToCopy, buttonElement);
    }
    
    function copyAllConnections(buttonElement) {
      const texts = document.querySelectorAll('.connection-text');
      if (texts.length === 0) {
          showToast('هیچ کانفیگی برای کپی یافت نشد.', false);
          return;
      }
      const allText = Array.from(texts).map(el => el.innerText.trim()).join("\n");
      copyToClipboard(allText, buttonElement);
    }

    function toggleDropdown() {
      const content = document.getElementById('dropdownContent');
      const icon = document.getElementById('dropdownIcon');
      content.classList.toggle('hidden');
      icon.classList.toggle('rotate-180');
    }

    // --- Data Initialization ---
    document.addEventListener('DOMContentLoaded', function() {
        const totalByte = parseInt('{{ .totalByte }}', 10) || 0;
        const downloadByte = parseInt('{{ .downloadByte }}', 10) || 0;
        const uploadByte = parseInt('{{ .uploadByte }}', 10) || 0;
        const usedBytes = downloadByte + uploadByte;
        
        document.getElementById('usedText').textContent = 'مصرف: ' + formatBytes(usedBytes);
        if (totalByte === 0) {
            document.getElementById('remainingText').textContent = 'حجم کل: نامحدود';
            document.getElementById('usageBar').style.width = '2%';
        } else {
            const remainingBytes = totalByte - usedBytes;
            document.getElementById('remainingText').textContent = 'باقیمانده: ' + formatBytes(remainingBytes < 0 ? 0 : remainingBytes);
            const usagePercentage = Math.min(100, (usedBytes / totalByte) * 100);
            document.getElementById('usageBar').style.width = usagePercentage + '%';
        }

        const expireValue = '{{ .expire }}';
        const expireDateElement = document.getElementById('expireDate');
        let expireTimestamp = 0;
        if (expireValue && expireValue !== '0') {
            expireTimestamp = parseInt(expireValue, 10) * 1000;
        }

        if (!expireTimestamp) {
            expireDateElement.textContent = 'نامحدود';
        } else {
            const expireDate = new Date(expireTimestamp);
            const { jy, jm, jd } = jalaali.toJalaali(expireDate.getFullYear(), expireDate.getMonth() + 1, expireDate.getDate());
            expireDateElement.textContent = `${jy}/${String(jm).padStart(2, '0')}/${String(jd).padStart(2, '0')}`;
        }

        const statusElement = document.getElementById('status');
        let isActive = false;
        if (totalByte === 0) { // Unlimited traffic
            isActive = !expireTimestamp || expireTimestamp > Date.now();
        } else { // Limited traffic
            isActive = (usedBytes < totalByte) && (!expireTimestamp || expireTimestamp > Date.now());
        }

        if (isActive) {
            statusElement.textContent = 'فعال';
            statusElement.previousElementSibling.firstElementChild.classList.replace('text-red-400', 'text-green-400');
        } else {
            statusElement.textContent = 'غیرفعال';
            // It's already red by default, but this ensures it
             statusElement.previousElementSibling.firstElementChild.classList.add('text-red-400');
             statusElement.previousElementSibling.firstElementChild.classList.remove('text-green-400');
        }
      
        try {
            new QRious({
            element: document.getElementById('qrcode'),
            value: '{{ .subUrl }}',
            size: 200,
            level: 'H',
            background: '#ffffff',
            foreground: '#000000',
            padding: 16
            });
        } catch (error) {
            console.error('Error generating QR code:', error);
            const qrcodeElement = document.getElementById('qrcode');
            if (qrcodeElement) {
            qrcodeElement.insertAdjacentHTML('afterend', '<p class="text-red-500 mt-2">خطا در ایجاد کد QR</p>');
            }
        }
    });
</script>
</body>
</html>
